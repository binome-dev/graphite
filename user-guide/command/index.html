
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../node/">
      
      
        <link rel="next" href="../tools/tool/">
      
      
        
      
      
      <link rel="icon" href="../../static/GRAPHITE_Favico_Dark.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Command - Graphite Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#command" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Graphite Documentation" class="md-header__button md-logo" aria-label="Graphite Documentation" data-md-component="logo">
      
  <img src="../../static/GRAPHITE_Logotype.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Graphite Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Command
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/binome-dev/graphite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    binome-dev/graphite
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Graphite Documentation" class="md-nav__button md-logo" aria-label="Graphite Documentation" data-md-component="logo">
      
  <img src="../../static/GRAPHITE_Logotype.png" alt="logo">

    </a>
    Graphite Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/binome-dev/graphite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    binome-dev/graphite
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/creating-a-simple-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simple Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/getting-started-with-assistants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started with Assistants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/configuring-event-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuring Event Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/connecting-to-an-mcp-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connecting to an MCP Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/configuring-integration-with-arize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration with Arize
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Assistant
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-driven-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Driven Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow-components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow Components
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Node
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Command
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Command
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Benefits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Benefits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-separation-of-concerns" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Separation of Concerns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-data-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Data Transformation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-automatic-tool-registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Automatic Tool Registration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-flexibility-and-extensibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Flexibility and Extensibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-improved-testability" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Improved Testability
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-command-class" class="md-nav__link">
    <span class="md-ellipsis">
      
        Base Command Class
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Base Command Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#factory-method" class="md-nav__link">
    <span class="md-ellipsis">
      
        Factory Method
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#built-in-command-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Built-in Command Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Built-in Command Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llmcommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        LLMCommand
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncallcommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        FunctionCallCommand
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-command-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Command Implementations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example Command Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#embeddingresponsecommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        EmbeddingResponseCommand
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ragresponsecommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        RagResponseCommand
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedding-response-command-and-rag-response-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        Embedding Response Command and RAG Response Command
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Command Registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Command Registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-use_command-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the @use_command Decorator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-lookup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Registry Lookup
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-custom-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating Custom Commands
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating Custom Commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-create-custom-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Create Custom Commands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-define-your-custom-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Define Your Custom Command
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-register-the-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Register the Command
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-advanced-custom-command-with-multiple-data-sources" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Advanced Custom Command with Multiple Data Sources
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Usage Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Usage Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-conditional-command-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Conditional Command Selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-command-with-state-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Command with State Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-command-with-error-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Command with Error Recovery
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-keep-commands-focused" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Keep Commands Focused
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-use-meaningful-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Use Meaningful Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-handle-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Handle Edge Cases
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-document-complex-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Document Complex Logic
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration with Workflows
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tools
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tools
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/llm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenAI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/ollama/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ollama
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/function/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Function Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/function-call/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Function Call Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Topics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Topics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/topic_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Topic Base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/topic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Topic Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/input_topics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Input Topics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/output_topics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Output Topics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/topic_event_cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topics/subscription_expression/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscription Expressions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Events
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Events
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../events/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Events System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../events/event_store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../events/event_graph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Graph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Infrastructure
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Infrastructure
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../containers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../builder-pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Builder Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../invoke-decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Invoke Decorators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conventional-rules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Conventional Rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Benefits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Benefits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-separation-of-concerns" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Separation of Concerns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-data-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Data Transformation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-automatic-tool-registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Automatic Tool Registration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-flexibility-and-extensibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Flexibility and Extensibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-improved-testability" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Improved Testability
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-command-class" class="md-nav__link">
    <span class="md-ellipsis">
      
        Base Command Class
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Base Command Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#factory-method" class="md-nav__link">
    <span class="md-ellipsis">
      
        Factory Method
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#built-in-command-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Built-in Command Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Built-in Command Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llmcommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        LLMCommand
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functioncallcommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        FunctionCallCommand
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-command-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Command Implementations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example Command Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#embeddingresponsecommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        EmbeddingResponseCommand
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ragresponsecommand" class="md-nav__link">
    <span class="md-ellipsis">
      
        RagResponseCommand
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedding-response-command-and-rag-response-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        Embedding Response Command and RAG Response Command
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-registration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Command Registration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Command Registration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-use_command-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using the @use_command Decorator
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-lookup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Registry Lookup
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-custom-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating Custom Commands
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating Custom Commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-create-custom-commands" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Create Custom Commands
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-define-your-custom-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Define Your Custom Command
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-register-the-command" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Register the Command
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-advanced-custom-command-with-multiple-data-sources" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Advanced Custom Command with Multiple Data Sources
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Usage Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Usage Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-conditional-command-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Conditional Command Selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-command-with-state-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Command with State Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-command-with-error-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Command with Error Recovery
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-keep-commands-focused" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Keep Commands Focused
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-use-meaningful-names" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Use Meaningful Names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-handle-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Handle Edge Cases
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-document-complex-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Document Complex Logic
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-with-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration with Workflows
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="command">Command</h1>
<p>The <strong>Command</strong> implements the Command Pattern in Graphite, providing a crucial abstraction layer that separates workflow orchestration (Nodes) from execution logic (Tools). Commands encapsulate the execution logic and data preparation, allowing nodes to delegate processing to tools without needing to understand the internal implementation details.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p>The Command Pattern in Graphite creates a clear separation between:</p>
<ul>
<li><strong>Orchestration Layer</strong>: Nodes manage workflow execution and topic-based messaging</li>
<li><strong>Execution Layer</strong>: Tools perform the actual processing (LLM calls, function execution, etc.)</li>
<li><strong>Command Layer</strong>: Commands bridge the gap, handling data transformation and tool invocation</li>
</ul>
<p>This architecture enables flexible, testable, and maintainable workflows where components can be easily swapped, extended, or customized.</p>
<h2 id="core-benefits">Core Benefits</h2>
<h3 id="1-separation-of-concerns">1. Separation of Concerns</h3>
<p>Commands isolate tool invocation logic from workflow orchestration, making the system more modular and easier to understand.</p>
<h3 id="2-data-transformation">2. Data Transformation</h3>
<p>Commands handle the complex task of transforming topic event data into the format expected by tools, including:</p>
<ul>
<li>Message aggregation from multiple topic events</li>
<li>Conversation history reconstruction</li>
<li>Tool call message ordering</li>
<li>Context-specific data preparation</li>
</ul>
<h3 id="3-automatic-tool-registration">3. Automatic Tool Registration</h3>
<p>The <code>@use_command</code> decorator provides automatic command registration for tool types:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nd">@use_command</span><span class="p">(</span><span class="n">LLMCommand</span><span class="p">)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyLLMTool</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="c1"># Tool implementation</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">pass</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># Command is automatically created when tool is used</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">command</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">for_tool</span><span class="p">(</span><span class="n">my_llm_tool</span><span class="p">)</span>  <span class="c1"># Returns LLMCommand instance</span>
</span></code></pre></div>
<h3 id="4-flexibility-and-extensibility">4. Flexibility and Extensibility</h3>
<p>Tools can be easily swapped without changing workflow structure, and new command types can be added for specialized processing needs.</p>
<h3 id="5-improved-testability">5. Improved Testability</h3>
<p>Commands can be tested independently from workflows and nodes, enabling better unit testing and debugging.</p>
<h2 id="base-command-class">Base Command Class</h2>
<p>The <code>Command</code> base class provides the foundational interface:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base command class for tool execution.&quot;&quot;&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">tool</span><span class="p">:</span> <span class="n">Tool</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MsgsAGen</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Asynchronous tool invocation.&quot;&quot;&quot;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>            <span class="n">invoke_context</span><span class="p">,</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">get_tool_input</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="p">):</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>            <span class="k">yield</span> <span class="n">message</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform topic events into tool input format.&quot;&quot;&quot;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="n">all_messages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>            <span class="n">all_messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="k">return</span> <span class="n">all_messages</span>
</span></code></pre></div>
<h3 id="key-methods">Key Methods</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invoke</code></td>
<td>Asynchronous tool execution supporting streaming</td>
</tr>
<tr>
<td><code>get_tool_input</code></td>
<td>Transforms topic events into tool-compatible format</td>
</tr>
<tr>
<td><code>to_dict</code></td>
<td>Serializes command state for persistence or debugging</td>
</tr>
</tbody>
</table>
<h3 id="factory-method">Factory Method</h3>
<p>The <code>Command.for_tool()</code> factory method automatically selects the appropriate command class:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Automatic command selection based on tool type</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">llm_command</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">for_tool</span><span class="p">(</span><span class="n">my_llm_tool</span><span class="p">)</span>      <span class="c1"># Returns LLMCommand</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">func_command</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">for_tool</span><span class="p">(</span><span class="n">my_func_tool</span><span class="p">)</span>    <span class="c1"># Returns FunctionCallCommand</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">base_command</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="n">for_tool</span><span class="p">(</span><span class="n">generic_tool</span><span class="p">)</span>    <span class="c1"># Returns Command</span>
</span></code></pre></div>
<h2 id="built-in-command-types">Built-in Command Types</h2>
<h3 id="llmcommand">LLMCommand</h3>
<p>The <code>LLMCommand</code> handles complex data preparation for Language Model tools, including conversation history and tool call ordering. This command automatically applies sophisticated data preparation logic specific to LLM interactions.</p>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Conversation History Reconstruction</strong>: Retrieves and orders conversation history from previous assistant responses</li>
<li><strong>Tool Call Message Ordering</strong>: Ensures tool call responses immediately follow their corresponding LLM tool calls</li>
<li><strong>Event Graph Processing</strong>: Uses topological sorting to maintain proper message chronology</li>
<li><strong>Context-Aware Data Preparation</strong>: Filters out current request data to prevent circular references</li>
</ul>
<p><strong>Data Processing Flow</strong>:</p>
<ol>
<li>Retrieves conversation history from the event store</li>
<li>Filters out messages from the current assistant request</li>
<li>Processes current topic events using event graph topology</li>
<li>Reorders tool call messages to follow their corresponding LLM messages</li>
<li>Combines and sorts all messages by timestamp</li>
</ol>
<p><strong>Use Cases</strong>:</p>
<ul>
<li>Conversational AI assistants with memory</li>
<li>Context-aware language model interactions</li>
</ul>
<h3 id="functioncallcommand">FunctionCallCommand</h3>
<p>The <code>FunctionCallCommand</code> processes tool call messages for function execution, extracting unprocessed function calls from topic events.</p>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Unprocessed Tool Call Detection</strong>: Identifies tool calls that haven't been processed yet</li>
<li><strong>Duplicate Prevention</strong>: Filters out tool call messages that already have responses</li>
<li><strong>Event Processing</strong>: Handles messages from nodes in the workflow</li>
</ul>
<p><strong>Data Processing Logic</strong>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>                   <span class="n">node_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="c1"># Extract all input messages from events</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">input_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">node_input</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="c1"># Find already processed tool calls</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">processed_tool_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">input_messages</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">]</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="c1"># Return only unprocessed tool call messages</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">tool_calls_messages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">input_messages</span><span class="p">:</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">and</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>            <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_tool_calls</span><span class="p">):</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>            <span class="n">tool_calls_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="k">return</span> <span class="n">tool_calls_messages</span>
</span></code></pre></div>
<p><strong>Use Cases</strong>:</p>
<ul>
<li>Function calling in LLM workflows</li>
<li>Tool execution based on model-generated tool calls  </li>
<li>Structured function invocation with parameter extraction</li>
</ul>
<h2 id="example-command-implementations">Example Command Implementations</h2>
<p>These examples show commands from test integrations that demonstrate specialized data preparation patterns.</p>
<h3 id="embeddingresponsecommand">EmbeddingResponseCommand</h3>
<p>The <code>EmbeddingResponseCommand</code> is used in test integrations for embedding-based retrieval tasks. It extracts the latest message for embedding processing:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmbeddingResponseCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>                       <span class="n">node_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="c1"># Only consider the last message contains the content to query</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="n">latest_event_data</span> <span class="o">=</span> <span class="n">node_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="n">latest_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>            <span class="n">latest_event_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latest_event_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>            <span class="k">else</span> <span class="n">latest_event_data</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="p">)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">latest_message</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Latest Message Extraction</strong>: Focuses on the most recent message for processing</li>
<li><strong>Simple Data Preparation</strong>: Minimal transformation for embedding queries</li>
</ul>
<h3 id="ragresponsecommand">RagResponseCommand</h3>
<p>The <code>RagResponseCommand</code> is used in test integrations for retrieval-augmented generation tasks. Similar to <code>EmbeddingResponseCommand</code>, it extracts the latest message:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RagResponseCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>                       <span class="n">node_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        <span class="c1"># Only consider the last message contains the content to query</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="n">latest_event_data</span> <span class="o">=</span> <span class="n">node_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="n">latest_message</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>            <span class="n">latest_event_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latest_event_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            <span class="k">else</span> <span class="n">latest_event_data</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="p">)</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">latest_message</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Query Focus</strong>: Extracts the latest user query for RAG processing</li>
<li><strong>Streamlined Input</strong>: Provides clean input for retrieval-augmented generation</li>
</ul>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invoke(invoke_context, input_data)</code></td>
<td>Calls the <code>function_tool</code>'s asynchronous <code>invoke</code>, yielding one or more <code>Message</code> objects in an async generator.</td>
</tr>
<tr>
<td><code>get_function_specs()</code></td>
<td>Retrieves the function specifications (schema, name, parameters) from the underlying <code>function_tool</code>.</td>
</tr>
<tr>
<td><code>to_dict()</code></td>
<td>Serializes the commands current state, including the <code>function_tool</code> configuration.</td>
</tr>
</tbody>
</table>
<p>By passing a <code>FunctionCallTool</code> to the <code>function_tool</code> field, you can seamlessly integrate function-based logic into a Nodes orchestration without embedding invoke details in the Node or the tool consumer. This separation keeps workflows flexible and easy to extend.</p>
<h2 id="embedding-response-command-and-rag-response-command">Embedding Response Command and RAG Response Command</h2>
<p><a href="https://github.com/binome-dev/graphite/blob/main/tests_integration/embedding_assistant/tools/embeddings/embedding_response_command.py"><code>EmbeddingResponseCommand</code></a> encapsulates a <code>RetrievalTool</code> for transforming input messages into embeddings, retrieving relevant content, and returning it as a <code>Message</code>. This command is used by <code>EmbeddingRetrievalNode</code>.</p>
<p><code>EmbeddingResponseCommand</code> fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>retrieval_tool</code></td>
<td>A <code>RetrievalTool</code> instance for embedding-based lookups, returning relevant data</td>
</tr>
</tbody>
</table>
<p><code>EmbeddingResponseCommand</code> methods:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invoke(invoke_context, input_data)</code></td>
<td>Asynchronously calls <code>retrieval_tool.invoke</code>, yielding one or more <code>Message</code> objects.</td>
</tr>
<tr>
<td><code>to_dict()</code></td>
<td>Serializes the commands state, including the <code>retrieval_tool</code> configuration.</td>
</tr>
</tbody>
</table>
<p><a href="https://github.com/binome-dev/graphite/blob/main/tests_integration/rag_assistant/tools/rags/rag_response_command.py"><code>RagResponseCommand</code></a> similarly delegates to a <code>RagTool</code> that performs retrieval-augmented generation. This command is used by <code>RagNode</code>.</p>
<p><code>RagResponseCommand</code> fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>rag_tool</code></td>
<td>A <code>RagTool</code> instance for retrieval-augmented generation.</td>
</tr>
</tbody>
</table>
<p><code>RagResponseCommand</code> methods:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invoke(invoke_context, input_data)</code></td>
<td>Asynchronously invokes <code>rag_tool.invoke</code>, yielding partial or complete messages from the retrieval-augmented flow.</td>
</tr>
<tr>
<td><code>to_dict()</code></td>
<td>Serializes the commands state, reflecting the assigned <code>RagTool</code> configuration.</td>
</tr>
</tbody>
</table>
<p>Both commands enable a node to delegate specialized retrieval operations to their respective tools, without needing to manage the internal logic of how embeddings or RAG processes are performed.</p>
<h2 id="command-registration">Command Registration</h2>
<h3 id="using-the-use_command-decorator">Using the @use_command Decorator</h3>
<p>Register custom commands for specific tool types:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">grafi.common.models.command</span><span class="w"> </span><span class="kn">import</span> <span class="n">use_command</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nd">@use_command</span><span class="p">(</span><span class="n">MyCustomCommand</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">MySpecialTool</span><span class="p">(</span><span class="n">Tool</span><span class="p">):</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tool that requires special data preparation.&quot;&quot;&quot;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="k">pass</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyCustomCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="c1"># Custom data transformation logic</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="k">return</span> <span class="n">transformed_messages</span>
</span></code></pre></div>
<h3 id="registry-lookup">Registry Lookup</h3>
<p>The command registry uses inheritance-based lookup:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Registry checks for exact match first</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">TOOL_COMMAND_REGISTRY</span><span class="p">[</span><span class="n">MySpecialTool</span><span class="p">]</span> <span class="o">=</span> <span class="n">MyCustomCommand</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># Then checks parent classes</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">RegisteredToolType</span><span class="p">):</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="k">return</span> <span class="n">AssociatedCommand</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="n">tool</span><span class="p">)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1"># Falls back to base Command</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">return</span> <span class="n">Command</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="n">tool</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="creating-custom-commands">Creating Custom Commands</h2>
<h3 id="when-to-create-custom-commands">When to Create Custom Commands</h3>
<p>Create custom commands when you need:</p>
<ol>
<li><strong>Specialized Data Preparation</strong>: Complex transformation of topic events into tool input</li>
<li><strong>Context-Specific Logic</strong>: Tool invocation that depends on workflow context</li>
<li><strong>Multi-Source Data</strong>: Aggregating data from multiple sources beyond topic events</li>
<li><strong>Custom Error Handling</strong>: Specialized error processing or recovery logic</li>
<li><strong>Performance Optimization</strong>: Optimized data processing for specific use cases</li>
</ol>
<h3 id="implementation-guide">Implementation Guide</h3>
<h4 id="1-define-your-custom-command">1. Define Your Custom Command</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">grafi.common.models.command</span><span class="w"> </span><span class="kn">import</span> <span class="n">Command</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">grafi.common.events.topic_events.consume_from_topic_event</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConsumeFromTopicEvent</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">grafi.common.models.invoke_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvokeContext</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">grafi.common.models.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Messages</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseQueryCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command for database query tools with caching and optimization.&quot;&quot;&quot;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>        <span class="c1"># Extract query parameters from messages</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="n">query_messages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;query:&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>                    <span class="n">query_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="c1"># Add context-specific optimizations</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>        <span class="k">if</span> <span class="n">invoke_context</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_cache&quot;</span><span class="p">):</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>            <span class="n">query_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_cache_hints</span><span class="p">(</span><span class="n">query_messages</span><span class="p">)</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        <span class="k">return</span> <span class="n">query_messages</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_cache_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add caching hints to query messages.&quot;&quot;&quot;</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        <span class="c1"># Custom caching logic</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>        <span class="k">return</span> <span class="n">messages</span>
</span></code></pre></div>
<h4 id="2-register-the-command">2. Register the Command</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nd">@use_command</span><span class="p">(</span><span class="n">DatabaseQueryCommand</span><span class="p">)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseQueryTool</span><span class="p">(</span><span class="n">Tool</span><span class="p">):</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tool for executing database queries.&quot;&quot;&quot;</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="c1"># Database query implementation</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="k">pass</span>
</span></code></pre></div>
<h4 id="3-advanced-custom-command-with-multiple-data-sources">3. Advanced Custom Command with Multiple Data Sources</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiSourceCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command that aggregates data from multiple sources.&quot;&quot;&quot;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="c1"># 1. Get base messages from topic events</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="n">base_messages</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_tool_input</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="c1"># 2. Retrieve external context</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="n">external_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_external_context</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">)</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="c1"># 3. Combine and optimize</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="n">combined_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_data_sources</span><span class="p">(</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>            <span class="n">base_messages</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>            <span class="n">external_data</span><span class="p">,</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>            <span class="n">invoke_context</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="p">)</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="k">return</span> <span class="n">combined_messages</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_external_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve additional context from external sources.&quot;&quot;&quot;</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>        <span class="c1"># Fetch from databases, APIs, files, etc.</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>        <span class="k">return</span> <span class="n">external_messages</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span> <span class="n">external</span><span class="p">:</span> <span class="n">Messages</span><span class="p">,</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>                              <span class="n">context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Intelligently combine multiple data sources.&quot;&quot;&quot;</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>        <span class="c1"># Custom combination logic</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>        <span class="k">return</span> <span class="n">combined_messages</span>
</span></code></pre></div>
<h2 id="advanced-usage-patterns">Advanced Usage Patterns</h2>
<h3 id="1-conditional-command-selection">1. Conditional Command Selection</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command that adapts behavior based on context.&quot;&quot;&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        <span class="k">if</span> <span class="n">invoke_context</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;streaming&quot;</span><span class="p">:</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_streaming_input</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="k">elif</span> <span class="n">invoke_context</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_batch_input</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_tool_input</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="2-command-with-state-management">2. Command with State Management</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StatefulCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command that maintains state across invocations.&quot;&quot;&quot;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="n">request_id</span> <span class="o">=</span> <span class="n">invoke_context</span><span class="o">.</span><span class="n">assistant_request_id</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="c1"># Use cached state if available</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="k">if</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_cache</span><span class="p">:</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_with_cache</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_cache</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="c1"># Create new state entry</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="n">processed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_fresh_input</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_cache</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_data</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="k">return</span> <span class="n">processed_data</span>
</span></code></pre></div>
<h3 id="3-command-with-error-recovery">3. Command with Error Recovery</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResilientCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command with built-in error recovery.&quot;&quot;&quot;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>                       <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MsgsAGen</span><span class="p">:</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="k">while</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>                <span class="n">tool_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tool_input</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>                <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">):</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>                    <span class="k">yield</span> <span class="n">message</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>                <span class="k">break</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>                <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>                    <span class="c1"># Yield error message as fallback</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>                    <span class="k">yield</span> <span class="p">[</span><span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>                    <span class="c1"># Modify input for retry</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>                    <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_retry_input</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-keep-commands-focused">1. Keep Commands Focused</h3>
<p>Each command should have a single, well-defined responsibility:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Good - Focused on LLM data preparation</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLMCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="c1"># Only LLM-specific data preparation</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="k">pass</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># Avoid - Mixed responsibilities</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLMAndDatabaseCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>  <span class="c1"># Don&#39;t do this</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="c1"># Both LLM and database logic</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="k">pass</span>
</span></code></pre></div>
<h3 id="2-use-meaningful-names">2. Use Meaningful Names</h3>
<p>Command names should clearly indicate their purpose:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Good</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConversationHistoryCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">FunctionCallProcessingCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">RealTimeDataCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="c1"># Avoid</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span> <span class="k">pass</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">SpecialCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span> <span class="k">pass</span>
</span></code></pre></div>
<h3 id="3-handle-edge-cases">3. Handle Edge Cases</h3>
<p>Always consider edge cases in data preparation:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>                   <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_data</span><span class="p">:</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Handle empty input</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>            <span class="k">continue</span>  <span class="c1"># Skip empty events</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="c1"># Validate message format</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>        <span class="n">valid_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)]</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">valid_messages</span><span class="p">)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="k">return</span> <span class="n">messages</span> <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="p">[</span><span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;No valid input&quot;</span><span class="p">)]</span>
</span></code></pre></div>
<h3 id="4-document-complex-logic">4. Document Complex Logic</h3>
<p>Use clear documentation for complex data transformations:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_tool_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>                   <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Messages</span><span class="p">:</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="sd">    Prepare LLM input with proper tool call ordering.</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="sd">    Process:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="sd">    1. Retrieve conversation history excluding current request</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="sd">    2. Process current topic events in topological order</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="sd">    3. Ensure tool call messages immediately follow LLM tool calls</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="sd">    4. Sort all messages by timestamp</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="sd">    Args:</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="sd">        invoke_context: Current invocation context</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="sd">        input_data: Topic events from workflow</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="sd">    Returns:</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="sd">        Properly ordered messages for LLM consumption</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="c1"># Implementation...</span>
</span></code></pre></div>
<h2 id="integration-with-workflows">Integration with Workflows</h2>
<p>Commands integrate seamlessly with Graphite's event-driven workflows:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># In a Node</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nd">@record_node_invoke</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoke_context</span><span class="p">:</span> <span class="n">InvokeContext</span><span class="p">,</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>           <span class="n">node_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConsumeFromTopicEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Messages</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="c1"># Command automatically handles data transformation</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="k">async</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">invoke_context</span><span class="p">,</span> <span class="n">node_input</span><span class="p">):</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>        <span class="k">yield</span> <span class="n">response</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c1"># Command selection happens automatically</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">builder</span><span class="p">()</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span><span class="n">my_llm_tool</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="c1"># node.command is automatically set to LLMCommand(tool=my_llm_tool)</span>
</span></code></pre></div>
<p>This architecture enables clean separation of concerns while maintaining the flexibility to customize data processing for specific use cases.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 2, 2026 09:43:54 UTC">January 2, 2026</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.top", "navigation.sections", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>